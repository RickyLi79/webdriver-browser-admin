var R=class{constructor(e){this.store=e}async chunkExecuteScript(e){let{store:t}=this;if(e.chunkInfo){let r=t.request[e.chunkInfo.id];r||(r=t.request[e.chunkInfo.id]=Array.from({length:e.chunkInfo.total})),r[e.chunkInfo.idx]=e.data}if(e.chunkInfo&&e.chunkInfo.idx+1!==e.chunkInfo.total)return;let s=e.data;e.chunkInfo&&(s=t.request[e.chunkInfo.id].join(""),delete t.request[e.chunkInfo.id]);let[o,u=[]]=JSON.parse(s);async function i(r,...a){let c=new Function(r).apply(null,a);return c?.then&&typeof c.then=="function"?await c:c}return new Promise((r,a)=>{i(o,...u).then(p=>{r(p)}).catch(p=>{a(p)})})}};function f(n,e){return e.includes(n)}var l=class{constructor(e){this.initOptions=e}requestQueue=[];nextRequestResolver;nextRequestReject;nextRequestTimeout;checkTimeoutTimer={};responseHandler={};addMessageQueue(e){this.requestQueue.push(e),this.flushRequests()}flushRequests(){this.nextRequestResolver&&this.requestQueue.length!==0&&(this.nextRequestResolver([...this.requestQueue]),this.deleteWaitForRequestsHandler())}deleteWaitForRequestsHandler(){this.requestQueue.splice(0),this.nextRequestResolver=void 0,this.nextRequestReject=void 0,this.nextRequestTimeout&&(clearTimeout(this.nextRequestTimeout),this.nextRequestTimeout=void 0)}deleteResponseHandler(e){delete this.responseHandler[e];let t=this.checkTimeoutTimer[e];t&&(clearTimeout(t),delete this.checkTimeoutTimer[e])}request(e){let t={timeout:this.initOptions.defaultTimeout,...e,requestId:crypto.randomUUID()};return new Promise((o,u)=>{if(this.responseHandler[t.requestId]={resolve:o,reject:u},t.timeout){let i=setTimeout(r=>{let a=this.responseHandler[r];if(a)try{a.reject({status:408,data:Date.now()})}finally{this.deleteResponseHandler(r)}},t.timeout,t.requestId);this.checkTimeoutTimer[t.requestId]=i}this.addMessageQueue(t)})}response(e){let t=this.responseHandler[e.requestId];if(!t)return;let s=e.data;try{f(e.status,[404,500])?t.reject({status:e.status,data:s}):t.resolve({status:e.status,data:s})}finally{this.deleteResponseHandler(e.requestId)}}waitForRequests(){if(this.requestQueue.length>0){let t=[...this.requestQueue];return this.requestQueue.splice(0),Promise.resolve(t)}return new Promise((t,s)=>{this.nextRequestResolver=o=>{t(o)},this.nextRequestReject=s,this.nextRequestTimeout=setTimeout(()=>{this.nextRequestResolver?.([])},this.initOptions.holdTimeSec*1e3*.9)})}};var y="Resource";async function d(n,...e){let s=new Function(n).apply(null,e);return s?.then&&typeof s.then=="function"?await s:s}function q(n,e="default"){return new Function(n).apply(null)[e]}var m=class{requestQueue;constructor({requestQueue:e}){this.requestQueue=e}async loadResource(e){if("data"in e)return{status:200,data:e.data};let t=await this.requestQueue.request({scope:y,request:"load",data:{...e,itemGetter:0}}),{itemGetter:s,property:o="default"}=e,u;return t.data.contentType==="js"?s?u=await d(s.toString(),t.data.content):u=q(t.data.content,o):t.data.contentType==="json"?u=JSON.parse(t.data.content):u=t.data.content,{status:t.status,data:u}}async loadAndRun(e,...t){let s={scriptStatus:0,argsStatus:[],status:0,result:void 0},o=await this.loadResource(e);if(s.scriptStatus=o.status,o.status===404)return s;let u=[];for(let i in t){let r=t[i],a=r?await this.loadResource(r):{status:200,data:void 0};if(s.argsStatus[i]=a.status,a.status===404)return s;u.push(a.data)}try{let i=await d(`return (${o.data}).apply(this, arguments)`,...u);s.status=200,s.result=i}catch(i){s.status=500,s.message=i?.message??i?.toString?.()??"runtime error"}return s}};var h=class n{static instance;static getSingleton(){return this.instance?console.debug("skip init WdbBrowserLib"):(this.instance=new n,console.debug("init WdbBrowserLib!")),this.instance}chunkStore={request:{},response:{}};chunk;requestQueue;resourceManager;constructor(){this.chunk=new R(this.chunkStore),this.requestQueue=new l({holdTimeSec:1e3*60*10,defaultTimeout:6e4}),this.resourceManager=new m({requestQueue:this.requestQueue})}};function T(){let n=h.getSingleton();return window.__WDB_BROWSER_LIB__=n,n}T();
